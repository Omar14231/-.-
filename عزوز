-- Services
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")
local Workspace = game:GetService("Workspace")

-- إعدادات المطر
local RAIN_DENSITY = 500 -- عدد قطرات المطر
local RAIN_SPEED = 200 -- سرعة المطر
local RAIN_LENGTH = 20 -- طول قطرات المطر
local NIGHT_TIME = 0 -- وقت الليل (24 ساعة)

-- متغيرات
local rainParts = {}
local rainConnections = {}
local skyParts = {}
local sound
local player = Players.LocalPlayer

-- دالة لتحويل الوقت إلى ليل
local function setNightTime()
	Lighting.ClockTime = NIGHT_TIME
	Lighting.TimeOfDay = "00:00:00"
	
	-- تغيير إعدادات السماء
	Lighting.Brightness = 0.1
	Lighting.OutdoorAmbient = Color3.fromRGB(50, 50, 70)
	Lighting.FogColor = Color3.fromRGB(20, 20, 40)
	Lighting.FogEnd = 1000
	Lighting.GeographicLatitude = 45
	
	-- تعديل الشمس
	if Lighting:FindFirstChild("SunRaysEffect") then
		Lighting.SunRaysEffect.Intensity = 0.01
	end
	
	-- تعديل الضباب
	if Lighting:FindFirstChild("Atmosphere") then
		Lighting.Atmosphere.Density = 0.3
		Lighting.Atmosphere.Offset = 0.25
		Lighting.Atmosphere.Color = Color3.fromRGB(100, 100, 150)
		Lighting.Atmosphere.Decay = Color3.fromRGB(50, 50, 100)
		Lighting.Atmosphere.Glare = 0
		Lighting.Atmosphere.Haze = 5
	end
	
	-- تعديل السماء
	if Lighting:FindFirstChild("Sky") then
		Lighting.Sky.MoonTextureId = "rbxassetid://6444320592"
		Lighting.Sky.MoonAngularSize = 30
		Lighting.Sky.StarCount = 5000
		Lighting.Sky.SunTextureId = ""
		
		-- غيوم ليلية
		Lighting.Sky.Clouds.Enabled = true
		Lighting.Sky.Clouds.Color = Color3.fromRGB(40, 40, 60)
		Lighting.Sky.Clouds.Cover = 0.8
		Lighting.Sky.Clouds.Density = 0.7
	end
end

-- دالة لإنشاء اسم "عزوز" في السماء
local function createSkyName()
	-- إزالة الأجزاء القديمة إن وجدت
	for _, part in pairs(skyParts) do
		part:Destroy()
	end
	skyParts = {}
	
	-- تحديد موقع فوق رأس اللاعب
	local character = player.Character
	if not character then return end
	
	local head = character:FindFirstChild("Head")
	if not head then return end
	
	-- إنشاء اسم "عزوز" بحروف مضيئة
	local letters = {
		ع = {
			{-1, 2}, {0, 2}, {1, 2}, {2, 1}, {2, 0}, {1, -1}, {0, -2}, {-1, -1}, {-2, 0}, {-2, 1}
		},
		ز = {
			{-1, 2}, {0, 2}, {1, 2}, {1, 1}, {0, 0}, {-1, -1}, {-1, -2}, {0, -2}, {1, -2}
		},
		و = {
			{0, 2}, {0, 1}, {0, 0}, {-1, -1}, {0, -2}, {1, -1}
		}
	}
	
	local letterSpacing = 6
	local totalWidth = 0
	
	-- حساب العرض الإجمالي
	for i = 1, 3 do
		if i == 1 then totalWidth = totalWidth + 4
		elseif i == 2 then totalWidth = totalWidth + 4
		else totalWidth = totalWidth + 3 end
	end
	
	totalWidth = totalWidth + (letterSpacing * 2)
	local startX = -totalWidth / 2
	
	-- إنشاء الحروف
	local letterIndex = 0
	for letterName, points in pairs(letters) do
		for _, point in pairs(points) do
			local x = startX + (letterIndex * letterSpacing) + point[1]
			local y = point[2]
			
			local part = Instance.new("Part")
			part.Name = "SkyLetter"
			part.Size = Vector3.new(0.5, 0.5, 0.5)
			part.Position = head.Position + Vector3.new(x * 2, 50 + y, 0)
			part.Anchored = true
			part.CanCollide = false
			part.Material = Enum.Material.Neon
			part.BrickColor = BrickColor.new("Cyan")
			part.Transparency = 0.1
			
			-- جعلها مضيئة
			local light = Instance.new("PointLight")
			light.Brightness = 2
			light.Range = 10
			light.Color = Color3.fromRGB(0, 255, 255)
			light.Parent = part
			
			-- تأثير توهج
			local surfaceGui = Instance.new("SurfaceGui")
			surfaceGui.Face = Enum.NormalId.Top
			surfaceGui.AlwaysOnTop = true
			surfaceGui.Parent = part
			
			local frame = Instance.new("Frame")
			frame.Size = UDim2.new(1, 0, 1, 0)
			frame.BackgroundColor3 = Color3.fromRGB(0, 200, 255)
			frame.BackgroundTransparency = 0.7
			frame.BorderSizePixel = 0
			frame.Parent = surfaceGui
			
			part.Parent = Workspace
			table.insert(skyParts, part)
		end
		letterIndex = letterIndex + 1
	end
	
	-- إنارة إضافية حول الاسم
	for i = 1, 20 do
		local angle = math.rad(i * 18)
		local radius = 15
		local x = math.cos(angle) * radius
		local z = math.sin(angle) * radius
		
		local part = Instance.new("Part")
		part.Name = "SkyGlow"
		part.Size = Vector3.new(1, 1, 1)
		part.Position = head.Position + Vector3.new(x, 50, z)
		part.Anchored = true
		part.CanCollide = false
		part.Material = Enum.Material.Neon
		part.BrickColor = BrickColor.new("Cyan")
		part.Transparency = 0.8
		
		local light = Instance.new("PointLight")
		light.Brightness = 1
		light.Range = 15
		light.Color = Color3.fromRGB(100, 200, 255)
		light.Parent = part
		
		part.Parent = Workspace
		table.insert(skyParts, part)
	end
	
	-- تحديث موقع الاسم باستمرار
	local updateConnection = RunService.RenderStepped:Connect(function()
		if character and head then
			for i, part in pairs(skyParts) do
				if part.Name == "SkyLetter" then
					local offset = part.Position - head.Position
					part.Position = head.Position + Vector3.new(offset.X, 50, offset.Z)
				elseif part.Name == "SkyGlow" then
					local offset = part.Position - head.Position
					part.Position = head.Position + Vector3.new(offset.X, 50, offset.Z)
				end
			end
		end
	end)
	
	table.insert(rainConnections, updateConnection)
end

-- دالة لإنشاء المطر
local function createRain()
	-- تنظيف المطر القديم
	cleanupRain()
	
	-- إنشاء قطرات المطر
	for i = 1, RAIN_DENSITY do
		local rainPart = Instance.new("Part")
		rainPart.Name = "RainDrop"
		rainPart.Size = Vector3.new(0.1, RAIN_LENGTH, 0.1)
		rainPart.Transparency = 0.3
		rainPart.Color = Color3.fromRGB(150, 200, 255)
		rainPart.Material = Enum.Material.Neon
		rainPart.CanCollide = false
		rainPart.Anchored = true
		rainPart.CastShadow = false
		
		-- توهج خفيف للمطر
		local light = Instance.new("PointLight")
		light.Brightness = 0.5
		light.Range = 5
		light.Color = Color3.fromRGB(100, 150, 255)
		light.Parent = rainPart
		
		-- وضع عشوائي في السماء
		local x = math.random(-200, 200)
		local y = math.random(50, 100)
		local z = math.random(-200, 200)
		rainPart.Position = Vector3.new(x, y, z)
		
		rainPart.Parent = Workspace
		table.insert(rainParts, rainPart)
	end
	
	-- تأثير صوت المطر
	sound = Instance.new("Sound")
	sound.Name = "RainSound"
	sound.SoundId = "rbxassetid://911847055" -- صوت مطر واقعي
	sound.Volume = 0.6
	sound.Looped = true
	sound.Parent = Workspace
	sound:Play()
	
	-- جعل المطر يتحرك
	local rainUpdate = RunService.RenderStepped:Connect(function(deltaTime)
		for _, rainPart in pairs(rainParts) do
			-- تحريك المطر للأسفل
			local currentPos = rainPart.Position
			local newY = currentPos.Y - (RAIN_SPEED * deltaTime)
			
			-- إذا وصل المطر للأرض، أعده للأعلى
			if newY < 0 then
				newY = math.random(50, 100)
				rainPart.Position = Vector3.new(
					math.random(-200, 200),
					newY,
					math.random(-200, 200)
				)
			else
				rainPart.Position = Vector3.new(
					currentPos.X,
					newY,
					currentPos.Z
				)
			end
			
			-- اهتزاز خفيف للمطر لجعله واقعي
			rainPart.CFrame = rainPart.CFrame * CFrame.Angles(
				math.rad(math.random(-5, 5)) * deltaTime,
				math.rad(math.random(-5, 5)) * deltaTime,
				0
			)
		end
		
		-- تحديث موقع المطر حول اللاعب
		local character = player.Character
		if character then
			local root = character:FindFirstChild("HumanoidRootPart")
			if root then
				for _, rainPart in pairs(rainParts) do
					local distance = (rainPart.Position - root.Position).Magnitude
					if distance > 150 then
						local direction = (rainPart.Position - root.Position).Unit
						rainPart.Position = root.Position + (direction * 100) + Vector3.new(0, 50, 0)
					end
				end
			end
		end
	end)
	
	table.insert(rainConnections, rainUpdate)
end

-- دالة لتنظيف المطر
local function cleanupRain()
	-- إيقاف الصوت
	if sound then
		sound:Stop()
		sound:Destroy()
		sound = nil
	end
	
	-- إزالة قطرات المطر
	for _, part in pairs(rainParts) do
		part:Destroy()
	end
	rainParts = {}
	
	-- قطع الاتصالات
	for _, connection in pairs(rainConnections) do
		connection:Disconnect()
	end
	rainConnections = {}
	
	-- إزالة اسم السماء
	for _, part in pairs(skyParts) do
		part:Destroy()
	end
	skyParts = {}
end

-- دالة لإنشاء تأثيرات إضافية
local function createEffects()
	-- برق عشوائي
	local lightningConnection = RunService.Heartbeat:Connect(function()
		if math.random(1, 500) == 1 then -- فرصة 0.2% كل إطار
			-- وميض السماء
			local originalBrightness = Lighting.Brightness
			
			-- وميض سريع
			for i = 1, 3 do
				Lighting.Brightness = 0.5
				task.wait(0.05)
				Lighting.Brightness = originalBrightness
				task.wait(0.05)
			end
			
			-- صوت الرعد بعد البرق
			task.wait(math.random(1, 3))
			
			local thunderSound = Instance.new("Sound")
			thunderSound.SoundId = "rbxassetid://911847133" -- صوت رعد
			thunderSound.Volume = 0.4
			thunderSound.Parent = Workspace
			thunderSound:Play()
			
			game.Debris:AddItem(thunderSound, 5)
		end
	end)
	
	table.insert(rainConnections, lightningConnection)
	
	-- تأثير ضباب متحرك
	local fogParticles = Instance.new("Part")
	fogParticles.Name = "FogEffect"
	fogParticles.Size = Vector3.new(200, 50, 200)
	fogParticles.Position = Vector3.new(0, 5, 0)
	fogParticles.Transparency = 1
	fogParticles.Anchored = true
	fogParticles.CanCollide = false
	fogParticles.Parent = Workspace
	
	local particleEmitter = Instance.new("ParticleEmitter")
	particleEmitter.Rate = 100
	particleEmitter.Lifetime = NumberRange.new(10, 20)
	particleEmitter.Size = NumberSequence.new({
		NumberSequenceKeypoint.new(0, 5),
		NumberSequenceKeypoint.new(0.5, 10),
		NumberSequenceKeypoint.new(1, 15)
	})
	particleEmitter.Transparency = NumberSequence.new({
		NumberSequenceKeypoint.new(0, 0.7),
		NumberSequenceKeypoint.new(0.5, 0.5),
		NumberSequenceKeypoint.new(1, 0.9)
	})
	particleEmitter.Color = ColorSequence.new(Color3.fromRGB(150, 180, 220))
	particleEmitter.VelocitySpread = 50
	particleEmitter.Speed = NumberRange.new(2, 5)
	particleEmitter.Rotation = NumberRange.new(0, 360)
	particleEmitter.Parent = fogParticles
	
	-- تأثير تنقيط على الأرض
	local groundWetness = Instance.new("Part")
	groundWetness.Name = "GroundWetness"
	groundWetness.Size = Vector3.new(500, 0.1, 500)
	groundWetness.Position = Vector3.new(0, 0.1, 0)
	groundWetness.Anchored = true
	groundWetness.CanCollide = false
	groundWetness.Material = Enum.Material.SmoothPlastic
	groundWetness.Color = Color3.fromRGB(40, 60, 80)
	groundWetness.Transparency = 0.7
	groundWetness.Parent = Workspace
	
	-- توهج الأرض
	local groundLight = Instance.new("SurfaceLight")
	groundLight.Face = Enum.NormalId.Top
	groundLight.Brightness = 0.1
	groundLight.Range = 20
	groundLight.Color = Color3.fromRGB(50, 100, 150)
	groundLight.Parent = groundWetness
	
	table.insert(rainParts, fogParticles)
	table.insert(rainParts, groundWetness)
end

-- دالة رئيسية لبدء التأثيرات
local function startRainEffect()
	-- انتظار تحميل الشخصية
	repeat task.wait() until player.Character
	player.CharacterAdded:Connect(function()
		task.wait(1) -- انتظار تحميل الشخصية
		createSkyName()
	end)
	
	-- تعيين وقت الليل
	setNightTime()
	
	-- إنشاء المطر
	createRain()
	
	-- إنشاء التأثيرات الإضافية
	createEffects()
	
	-- إنشاء اسم "عزوز" في السماء
	createSkyName()
	
	-- منع تغيير الوقت تلقائياً
	Lighting:GetPropertyChangedSignal("ClockTime"):Connect(function()
		if Lighting.ClockTime ~= NIGHT_TIME then
			Lighting.ClockTime = NIGHT_TIME
		end
	end)
	
	print("✅ تم تفعيل تأثير المطر الليلي مع اسم 'عزوز' في السماء!")
end

-- دالة لإيقاف التأثيرات
local function stopRainEffect()
	cleanupRain()
	
	-- إعادة إعدادات الإضاءة الطبيعية
	Lighting.Brightness = 1
	Lighting.OutdoorAmbient = Color3.fromRGB(128, 128, 128)
	Lighting.FogColor = Color3.fromRGB(191, 191, 191)
	Lighting.FogEnd = 100000
	
	print("✅ تم إيقاف تأثير المطر الليلي")
end

-- بدء التأثيرات تلقائياً عند تشغيل السكريبت
startRainEffect()

-- إرجاع دوال التحكم للاستخدام الخارجي
return {
	StartRain = startRainEffect,
	StopRain = stopRainEffect,
	ToggleRain = function()
		if #rainParts > 0 then
			stopRainEffect()
		else
			startRainEffect()
		end
	end
}
