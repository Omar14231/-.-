-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local SoundService = game:GetService("SoundService")
local UserInputService = game:GetService("UserInputService")

-- التأكد من أن السكريبت يعمل على جانب العميل فقط
if not RunService:IsClient() then
	return
end

-- الحصول على اللاعب المحلي
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ❗ الجزء الأول: المشهد التمهيدي (شاشة الترحيب) 
-- ... (الكود الأول يبقى كما هو حتى نهاية المشهد التمهيدي) ...

-- ❗ الجزء الثاني: نظام الموت المحسّن

-- متغيرات التحكم
local isPlayerDead = false
local deathScreenGui = nil

-- وظيفة إظهار شاشة الموت
local function showDeathScreen()
    if isPlayerDead then return end
    isPlayerDead = true
    
    -- إخفاء الشخصية بشكل كامل بشاشة سوداء
    local fullBlackScreen = Instance.new("ScreenGui")
    fullBlackScreen.Name = "FullBlackScreen"
    fullBlackScreen.ResetOnSpawn = false
    fullBlackScreen.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    fullBlackScreen.IgnoreGuiInset = true
    
    local blackOverlay = Instance.new("Frame")
    blackOverlay.Name = "BlackOverlay"
    blackOverlay.Size = UDim2.new(1, 0, 1, 0)
    blackOverlay.Position = UDim2.new(0, 0, 0, 0)
    blackOverlay.BackgroundColor3 = Color3.new(0, 0, 0)
    blackOverlay.BackgroundTransparency = 1 -- تبدأ شفافة
    blackOverlay.BorderSizePixel = 0
    blackOverlay.Parent = fullBlackScreen
    
    fullBlackScreen.Parent = playerGui
    
    -- إنشاء شاشة الموت (الرسومات)
    deathScreenGui = Instance.new("ScreenGui")
    deathScreenGui.Name = "DeathScreen"
    deathScreenGui.ResetOnSpawn = false
    deathScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    deathScreenGui.IgnoreGuiInset = true
    
    -- خلفية سوداء شفافة
    local deathFrame = Instance.new("Frame")
    deathFrame.Name = "DeathFrame"
    deathFrame.Size = UDim2.new(1, 0, 1, 0)
    deathFrame.Position = UDim2.new(0, 0, 0, 0)
    deathFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    deathFrame.BackgroundTransparency = 0.8 -- أكثر شفافية
    deathFrame.BorderSizePixel = 0
    deathFrame.Parent = deathScreenGui
    
    -- النص "لقد مت"
    local deathText = Instance.new("TextLabel")
    deathText.Name = "DeathText"
    deathText.Size = UDim2.new(0.8, 0, 0.2, 0)
    deathText.Position = UDim2.new(0.1, 0, 0.3, 0)
    deathText.BackgroundTransparency = 1
    deathText.Text = "You Died"
    deathText.TextColor3 = Color3.new(1, 1, 1)
    deathText.TextTransparency = 1 -- تبدأ شفافة
    deathText.TextScaled = true
    deathText.Font = Enum.Font.GothamBold
    deathText.TextStrokeColor3 = Color3.new(0, 0, 0)
    deathText.TextStrokeTransparency = 0.3
    deathText.Parent = deathFrame
    
    -- شريط أحمر من الأسفل يصل للنصف
    local redBar = Instance.new("Frame")
    redBar.Name = "RedBar"
    redBar.Size = UDim2.new(1, 0, 0.02, 0)
    redBar.Position = UDim2.new(0, 0, 1, -10) -- يبدأ من الأسفل
    redBar.BackgroundColor3 = Color3.new(1, 0, 0) -- أحمر
    redBar.BackgroundTransparency = 0.3
    redBar.BorderSizePixel = 0
    redBar.AnchorPoint = Vector2.new(0, 1) -- نقطة الربط من الأسفل
    redBar.Parent = deathFrame
    
    -- النص "ستعود بعد 5 ثواني"
    local countdownText = Instance.new("TextLabel")
    countdownText.Name = "CountdownText"
    countdownText.Size = UDim2.new(0.8, 0, 0.1, 0)
    countdownText.Position = UDim2.new(0.1, 0, 0.55, 0)
    countdownText.BackgroundTransparency = 1
    countdownText.Text = "Respawn in 5"
    countdownText.TextColor3 = Color3.new(1, 1, 1)
    countdownText.TextTransparency = 1 -- تبدأ شفافة
    countdownText.TextScaled = true
    countdownText.Font = Enum.Font.Gotham
    countdownText.Parent = deathFrame
    
    -- النص "5" كبير في المنتصف
    local bigNumberText = Instance.new("TextLabel")
    bigNumberText.Name = "BigNumberText"
    bigNumberText.Size = UDim2.new(0.4, 0, 0.3, 0)
    bigNumberText.Position = UDim2.new(0.3, 0, 0.4, 0)
    bigNumberText.BackgroundTransparency = 1
    bigNumberText.Text = "5"
    bigNumberText.TextColor3 = Color3.new(1, 0.3, 0.3)
    bigNumberText.TextTransparency = 1 -- تبدأ شفافة
    bigNumberText.TextScaled = true
    bigNumberText.Font = Enum.Font.GothamBlack
    bigNumberText.TextStrokeColor3 = Color3.new(0, 0, 0)
    bigNumberText.TextStrokeTransparency = 0.2
    bigNumberText.Parent = deathFrame
    
    -- إضافة الشاشة إلى اللاعب
    deathScreenGui.Parent = playerGui
    
    -- 1. ظهور الشاشة السوداء الكاملة (لإخفاء الشخصية)
    local overlayFadeIn = createTween(blackOverlay, {BackgroundTransparency = 0}, 0.8)
    overlayFadeIn:Play()
    
    wait(0.5)
    
    -- 2. تشغيل صوت الموت
    local deathSound = Instance.new("Sound")
    deathSound.SoundId = "rbxassetid://1837517200"
    deathSound.Volume = 0.7
    deathSound.Parent = deathFrame
    deathSound:Play()
    
    -- 3. إظهار النص "لقد مت"
    local deathTextFadeIn = createTween(deathText, {TextTransparency = 0}, 1)
    deathTextFadeIn:Play()
    
    -- 4. ظهور الشريط الأحمر من الأسفل إلى النصف
    local barMoveUp = createTween(redBar, {Position = UDim2.new(0, 0, 0.5, 0)}, 1.5)
    barMoveUp:Play()
    
    wait(1)
    
    -- 5. إظهار النص "ستعود بعد 5 ثواني"
    local countdownFadeIn = createTween(countdownText, {TextTransparency = 0}, 0.8)
    countdownFadeIn:Play()
    
    -- 6. إظهار الرقم الكبير
    local numberFadeIn = createTween(bigNumberText, {TextTransparency = 0}, 0.5)
    numberFadeIn:Play()
    
    -- 7. تشغيل صوت العد التنازلي
    local countdownSound = Instance.new("Sound")
    countdownSound.SoundId = "rbxassetid://6586979979"
    countdownSound.Volume = 0.5
    countdownSound.Parent = deathFrame
    
    -- دالة العد التنازلي
    local function startCountdown()
        for i = 5, 1, -1 do
            bigNumberText.Text = tostring(i)
            countdownText.Text = "Respawn in " .. tostring(i)
            
            -- تشغيل صوت العد التنازلي لكل رقم
            countdownSound:Play()
            
            -- تأثير اهتزاز بسيط
            local shakeTween = createTween(bigNumberText, {
                Position = UDim2.new(0.3, math.random(-5, 5), 0.4, math.random(-5, 5))
            }, 0.1)
            shakeTween:Play()
            
            wait(1)
            
            -- إعادة الرقم لمكانه
            local resetTween = createTween(bigNumberText, {
                Position = UDim2.new(0.3, 0, 0.4, 0)
            }, 0.1)
            resetTween:Play()
        end
        
        -- بعد انتهاء العد التنازلي
        bigNumberText.Text = "0"
        countdownText.Text = "Respawning..."
        
        -- الانتظار قليلاً قبل إعادة اللاعب
        wait(0.5)
        
        -- ❗ إعادة اللاعب إلى الحياة (هنا ضع كود إعادة إحياء اللاعب)
        -- إذا كان لديك نظام إعادة إحياء، ضعه هنا
        
        -- 8. بدء الاختفاء التدريجي
        local deathTextFadeOut = createTween(deathText, {TextTransparency = 1}, 0.8)
        deathTextFadeOut:Play()
        
        local numberFadeOut = createTween(bigNumberText, {TextTransparency = 1}, 0.8)
        numberFadeOut:Play()
        
        local countdownFadeOut = createTween(countdownText, {TextTransparency = 1}, 0.8)
        countdownFadeOut:Play()
        
        -- تحريك الشريط الأحمر للأسفل
        local barMoveDown = createTween(redBar, {
            Position = UDim2.new(0, 0, 1, -10)
        }, 1)
        barMoveDown:Play()
        
        wait(0.8)
        
        -- 9. إزالة شاشة الموت
        local bgFadeOut = createTween(deathFrame, {BackgroundTransparency = 1}, 1)
        bgFadeOut:Play()
        
        -- 10. إزالة الشاشة السوداء الكاملة تدريجياً (للعودة للوضع الطبيعي)
        local overlayFadeOut = createTween(blackOverlay, {BackgroundTransparency = 1}, 1.5)
        overlayFadeOut:Play()
        
        wait(2)
        
        -- 11. تنظيف كل شيء
        deathScreenGui:Destroy()
        fullBlackScreen:Destroy()
        isPlayerDead = false
    end
    
    -- بدء العد التنازلي
    startCountdown()
end

-- ❗ نظام منع الإدخال أثناء الموت
local function blockInputDuringDeath()
    -- منع الحركة أثناء الموت
    if isPlayerDead then
        -- يمكنك إضافة كود لمنع تحريك الكاميرا أو الشخصية هنا
        -- مثال: UserInputService.MouseIconEnabled = false
    end
end

-- ❗ طرق تفعيل نظام الموت

-- الطريقة 1: عند موت اللاعب (الأفضل)
player.CharacterAdded:Connect(function(character)
    local humanoid = character:WaitForChild("Humanoid")
    humanoid.Died:Connect(function()
        showDeathScreen()
    end)
    
    -- لمنع الموت السريع المتكرر
    humanoid.StateChanged:Connect(function(oldState, newState)
        if newState == Enum.HumanoidStateType.Dead then
            -- يمكنك إضافة كود إضافي هنا
        end
    end)
end)

-- الطريقة 2: عند سقوط اللاعب من الخريطة
game.Workspace:WaitForChild(player.Name).HumanoidRootPart.Touched:Connect(function(part)
    if part.Name == "DeathZone" or part.Name == "Void" or part.Position.Y < -50 then
        if not isPlayerDead then
            showDeathScreen()
        end
    end
end)

-- الطريقة 3: للاختبار - عند الضغط على زر 'M'
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.M then
        if not isPlayerDead then
            showDeathScreen()
        end
    end
end)

-- ❗ وظيفة إعادة إحياء اللاعب (ضيف كودك هنا)
local function respawnPlayer()
    -- إذا كان لديك نظام إعادة إحياء، ضعه هنا
    -- مثال: player:LoadCharacter()
    
    -- أو استخدم النظام الافتراضي
    if player.Character then
        player.Character:BreakJoints()
    end
    wait(1)
    player:LoadCharacter()
end

print("✅ تم تحميل نظام الموت المحسّن!")
